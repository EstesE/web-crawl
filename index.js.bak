const Nightmare = require('nightmare');
const nightmare = Nightmare({ show: false })
const cheerio = require('cheerio');
const chalk = require('chalk');
const fs = require('fs-extra');
const { URL } = require('url');
const psl = require('psl');

let urls = [];
let visitedUrls = [];

let targetUrl = 'https://lyrics.wikia.com/wiki/LyricWiki';
let rootUrl = new URL(targetUrl);
rootUrl.psl = psl.parse(rootUrl.hostname);
if (rootUrl.psl.error) {
    console.log(rootUrl.psl.error.message);
} else {
    removeFile(rootUrl);
}

function isUsable(href) {
    // debugger;
    if (typeof href === 'object') {
        if (href.host.indexOf('lyrics.wikia.com') > -1) {
            return true;
        }
        return false;
        // return true;
    } else if (typeof href === 'string') {
        if (href.indexOf('tel:') > -1) { return false };
        if (href.indexOf('mailto://') > -1) { return false };
        if (href.indexOf('@') > -1) { return false; }
        // if (href.indexOf('#') > -1) { return false; }
        if (href === '#') {
            return false;
        }
        if (href.indexOf('void(0)') > -1 || href.indexOf('()') > -1 || href.indexOf('javascript:') > -1) { return false; }
        
        // if (href.indexOf('lyrics.wikia.com') === -1) {
        //     return false;
        // }
        if (href.indexOf('diff=') > -1) {
            return false;
        }
        if (href.indexOf('register') > -1) {
            return false;
        }
        if (href.indexOf('signin') > -1) {
            return false;
        }
        if (href.indexOf('Special:') > -1) {
            return false;
        }
        if (href.indexOf('Talk:') > -1) {
            return false;
        }
        if (href.indexOf('.jpg') > -1) {
            return false;
        }
        if (href.indexOf('User:') > -1) {
            return false;
        }
        if (href.indexOf('action=') > -1) {
            return false;
        }
        if (href.indexOf('lyrics.wikia.com/wiki/LyricWiki/lyrics.wikia.com') > -1) {
            return false;
        }
        if (href.indexOf('//fandom.wikia.com') > -1) {
            return false;
        }
        if (href.indexOf('//community.wikia.com') > -1) {
            return false;
        }
        if (href.indexOf('/wiki/') === -1) {
            return false;
        }
        
        if ((href.indexOf('lyrics.wikia.com') === -1 && (href.indexOf('https://') === -1 || href.indexOf('http://') === -1))) {
            if (href.indexOf('/wiki/') > -1) {
                if (href.indexOf('//') === -1) {
                    href = 'https://lyrics.wikia.com' + href;
                }
                if (href.indexOf('https://') === -1 && href.indexOf('http://') === -1) {
                    href = 'https:' + href;
                }
            }
            // debugger; // good
            // href = 'https://' + href;
            // console.log('hmm');
        } else if ((href.indexOf('lyrics.wikia.com') > -1 && (href.indexOf('https://' === -1) || href.indexOf('http://') === -1))) {
            // debugger; // bad ???
            // href = 'https:' + href; // This one
        }
        if ((href.indexOf('https:') === -1 && href.indexOf('http:')) === -1) {
            href = 'https:' + href;
        //     if (href.indexOf(`www.${rootUrl.psl.domain}`) > -1 || href.indexOf(rootUrl.psl.domain) > -1) {
        //         if (href.indexOf(`.${rootUrl.psl.domain}`) > -1) {// && href.indexOf(`www.${rootUrl.psl.domain}`) === -1) {
        //             return true;
        //         }
        //         return true;
        //     }
        //     return false;
            return true;
        }

        // if (href.indexOf('//') > -1) {
        //     return false;
        // }
        
        // if (href.indexOf(rootUrl) > -1) {
        //     return true;
        // }
        return true;
    } else {
        // debugger; // Undefined
        return false;
    }
    return true;
}

function updateFile(link) {
    fs.ensureFile('./links.txt', err => {
        if (err) return console.log(err);
        fs.appendFile('./links.txt', link + '\n', err => {
            if (err) return console.log(err);
        });
    });
}

function addLinks(links) {
    let $ = cheerio.load(links);
    $(links).each((i, link) => {
        // links.each(function(index) {
        //     console.log(this.attribs.href);
        // });
        // let href = $(link).attr('href');
        // debugger;
        // console.log('old: ' + $(link).attr('href'));
        // console.log('new: ' + link.attribs.href);
        let href = link.attribs.href;
        // console.log('isUsable: ' + isUsable(href));
        if (href) {
            if (isUsable(href)) {
                // debugger;
                if (urls.indexOf(targetUrl + $(link).attr('href')) === -1) {
                    let l = $(link).attr('href');
                    let x = '';
                    if (typeof l !== 'undefined') {
                        if (l.indexOf('https://') === -1 && l.indexOf('http://') === -1) {
                            if (l !== '/') {
                                // x = rootUrl.href + l.replace('/', '');
                                // debugger;
                                if (l.indexOf('//lyrics.wikia.com') > -1) {
                                    // debugger;
                                    x = 'https:' + l;
                                } else {
                                    // debugger;
                                    x = rootUrl.href.replace('/wiki/LyricWiki', '') + l;
                                }
                                // x = 'https:' + l;
                            } else {
                                x = rootUrl.href;
                            }
                        } else {
                            // Just pass it along.
                            x = l;
                        }
                        if (urls.indexOf(x) === -1 && visitedUrls.indexOf(x) === -1) {
                            urls.push(x);
                            console.log(chalk.gray(`  ~ adding new link `) + x + chalk.gray(` to `) + chalk.yellow(`urls `) + `(` + chalk.green(urls.length) + `)`);
                        }
                    }
                } else {
                    let index = null;
                    let x = urls.map((x, i) => {
                        if (x === href) {
                            index = i;
                        }
                    })
                }
            }
        }/* else {
            debugger;
        }*/
    });
}

function run(u) {
    const notifier = require('node-notifier');
    let urlPath = '';
    if (isUsable(u)) {
        if (typeof u === 'string') {
            if (visitedUrls.indexOf(u) === -1) {
                visitedUrls.push(u);
                updateFile(u);
                console.log(chalk.cyan(`+ `) + u + chalk.gray(` to `) + chalk.cyan(`visitedUrls `) + `(` + chalk.green(visitedUrls.length) + `)`);
                urls.pop();
                console.log(chalk.yellow(`- `) + u + chalk.gray(` from `) + chalk.yellow(`urls `) + `(` + chalk.green(urls.length) + `)`);
                urlPath = u;
            }
        } else if (typeof u === 'object') {
            // debugger;
            if (visitedUrls.indexOf(u.hostname) === -1) {
                visitedUrls.push(u.hostname);
                updateFile(u.origin);
                console.log(chalk.cyan(`+ `) + u.hostname + chalk.gray(` to `) + chalk.cyan(`visitedUrls `) + `(` + chalk.green(visitedUrls.length) + `)`);
                urls.pop();
                console.log(chalk.yellow(`- `) + u.hostname + chalk.gray(` from `) + chalk.yellow(`urls `) + `(` + chalk.green(urls.length) + `)`);
                urlPath = u;
            }
        }
        
        nightmare
            .goto(urlPath)
            .wait(1)
            .evaluate(function () {
                return document.body.innerHTML;
            })
            .then(function (body) {
                var $ = cheerio.load(body);
                var links = $('a');
                if (links.length > 0) {
                    addLinks(links);
                    if (urls.length > 0) {
                        let u = urls[urls.length - 1];
                        run(u);
                    } else {
                        // Nothing left in urls array
                        notifier.notify({
                            title: 'Web-Crawl',
                            message: 'Finished crawling'
                        });
                        console.log('Finished crawling');
                    }
                } else {
                    // No links found on page
                    if (urls.length > 0) {
                        let u = urls[urls.length - 1];
                        run(u);
                    } else {
                        // Nothing left in urls array
                        notifier.notify({
                            title: 'Web-Crawl',
                            message: 'Finished crawling'
                        });
                        console.log('Finished crawling');
                    }
                }
                var lyrics = $('.lyricbox');
                if (lyrics.length > 0) {
                    // console.log('**** ' + lyrics);
                    var title = $('.page-header__title');
                    if (title.length > 0) {
                        // console.log('**** ' + title);
                        var title_parts = title[0].children[0].data.split(':');
                        console.log(`Artist: ${title_parts[0]}`);
                        console.log(`Song: ${title_parts[1].replace(' Lyrics', '')}`);
                        console.log(`Lyrics: ${lyrics.eq(0).clone().html()}`);
                    }
                }
            })
            .catch(error => {
                console.log(error.details + ' - ' + error.message)
            });
    } else {
        notifier.notify({
            title: 'Web-Crawl',
            message: 'Nothing to crawl'
        });
        console.log('Nothing to crawl');
    }
}

function removeFile(rootUrl) {
    fs.remove('./links.txt', err => {
        if (err) return console.log(err);
        run(rootUrl);
    });
}
